<div class="container generalBody">
    <div class="page-header">
        <h2 class="page-title">
            <span class="badge bg-danger me-2">SALIDA</span>
            Registrar Egreso de Productos
        </h2>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <form [formGroup]="formMovimiento">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Producto *</label>
                                    <select formControlName="idProducto" class="form-select"
                                        (change)="onProductoChange()">
                                        <option [ngValue]="null">Seleccione un producto</option>
                                        <option *ngFor="let prod of listProducto" [value]="prod.idProducto">
                                            {{prod.codigo}} - {{prod.nombre}} (Stock: {{prod.stockActual}})
                                        </option>
                                    </select>
                                    <small class="text-danger"
                                        *ngIf="idProductoFb.touched && idProductoFb.errors?.['required']">
                                        Debe seleccionar un producto
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Cantidad *</label>
                                    <input type="number" formControlName="cantidad" class="form-control" min="1"
                                        [max]="productoSeleccionado?.stockActual || 999">
                                    <small class="text-danger" *ngIf="cantidadFb.touched && cantidadFb.errors?.['min']">
                                        La cantidad debe ser mayor a 0
                                    </small>
                                    <small class="text-danger"
                                        *ngIf="productoSeleccionado && cantidadFb.value > productoSeleccionado.stockActual">
                                        Excede el stock disponible
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Motivo *</label>
                                    <select formControlName="motivo" class="form-select">
                                        <option value="VENTA">Venta</option>
                                        <option value="MERMA">Merma</option>
                                        <option value="DEVOLUCION_PROVEEDOR">Devolución a Proveedor</option>
                                        <option value="AJUSTE">Ajuste de Inventario</option>
                                        <option value="OTRO">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Documento de Referencia</label>
                                    <input type="text" formControlName="documentoReferencia" class="form-control"
                                        placeholder="BOL-001-0001">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Observación</label>
                                    <textarea formControlName="observacion" class="form-control" rows="2"
                                        placeholder="Notas adicionales sobre la salida"></textarea>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
                                    Cancelar
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-danger" (click)="registrar()">
                                    Registrar Salida
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card" *ngIf="productoSeleccionado">
                <div class="card-header bg-light">
                    <strong>Información del Producto</strong>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Código:</strong> {{productoSeleccionado.codigo}}</p>
                    <p class="mb-2"><strong>Nombre:</strong> {{productoSeleccionado.nombre}}</p>
                    <p class="mb-2"><strong>Categoría:</strong> {{productoSeleccionado.nombreCategoria}}</p>
                    <hr>
                    <p class="mb-2 fs-5">
                        <strong>Stock Actual:</strong>
                        <span class="badge fs-6"
                            [ngClass]="productoSeleccionado.stockActual <= productoSeleccionado.stockMinimo ? 'bg-danger' : 'bg-primary'">
                            {{productoSeleccionado.stockActual}}
                        </span>
                    </p>
                    <p class="mb-0 text-muted small">
                        Stock mínimo: {{productoSeleccionado.stockMinimo}}
                    </p>
                    <div class="alert alert-warning mt-3 mb-0"
                        *ngIf="productoSeleccionado.stockActual <= productoSeleccionado.stockMinimo">
                        <small><strong>¡Atención!</strong> Stock bajo</small>
                    </div>
                </div>
            </div>
            <div class="card" *ngIf="!productoSeleccionado">
                <div class="card-body text-center text-muted">
                    <p class="mb-0">Seleccione un producto para ver su información</p>
                </div>
            </div>
        </div>
    </div>
</div>